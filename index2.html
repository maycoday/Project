<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aawaaz — Blind Analytics Engine</title>
<link rel="stylesheet" href="frontend/css/analytics.css">
</head>
<body>

<!-- MODE SWITCHER -->
<div id="modeSwitcher">
  <div class="mode-brand">
    <img src="assets/image-removebg-preview.png" alt="Aawaaz Logo" style="height: 95px; width: auto;">
  </div>
  <div style="display:flex;align-items:center;gap:16px">
    <span class="mode-label">MODE</span>
    <div class="mode-toggle">
      <button class="mode-btn" onclick="navigateMode('user')">User Portal</button>
      <button class="mode-btn" onclick="navigateMode('sim')">Simulation</button>
      <button class="mode-btn" onclick="navigateMode('authority')">Authority</button>
      <button class="mode-btn active" onclick="navigateMode('pattern')">Pattern Detection</button>
    </div>
  </div>
</div>

<!-- ══════════════════ TOP BAR ══════════════════ -->
<div id="topbar">
  <div class="tb-left">
    <div class="tb-logo">
      <img src="assets/image-removebg-preview.png" alt="Aawaaz Logo" style="height: 70px; width: auto; margin-right: 8px;">
      <div>
        <div class="tb-name" style="display: none;"> <em>Aawaaz</em></div>
        <div class="tb-sub">Blind Analytics Engine — Aawaaz Grievance Portal</div>
      </div>
    </div>
    <div class="tb-divider"></div>
    <div class="tb-codename">METADATA ONLY</div>
  </div>
  <div class="tb-right">
    <div class="live-ind"><div class="live-dot"></div>LIVE</div>
    <div class="view-tabs">
      <button class="vt on" onclick="setView('analytics')">Analytics</button>
      <button class="vt" onclick="setView('heatmap')">Heatmap</button>
      <button class="vt admin" onclick="setView('admin')">Sys Admin</button>
    </div>
    <div class="tb-clock" id="clock" style="display:none"></div>
  </div>
</div>

<!-- ══════════════════ SIM BAR ══════════════════ -->
<div id="simbar">
  <span class="sb-label">Inject Test Data →</span>
  <button class="sb-btn s" onclick="injectRandom()">⚡ Real Complaint</button>
  <button class="sb-btn w" onclick="injectHotspot()">🔥 Real Hotspot</button>
  <button class="sb-btn g" onclick="injectBatch(5)">📦 Real Batch ×5</button>
  <button class="sb-btn c" onclick="injectBatch(20)">🌊 Real Flood ×20</button>
  <button class="sb-btn c" onclick="injectBatch(50)" style="background:rgba(244,63,94,0.1);color:var(--rose);border:1px solid rgba(244,63,94,0.2)">🌊🌊 Mega Flood ×50</button>
  <div class="sb-sep"></div>
  <button class="sb-btn" style="background:rgba(139,92,246,0.1);color:var(--purp);border:1px solid rgba(139,92,246,0.2)" onclick="clearData()">🗑 Clear All</button>
  <div class="sb-count">Total Reports: <span id="totalCount">0</span> &nbsp;·&nbsp; Hotspots: <span id="hotspotCount" style="color:var(--rose)">0</span> &nbsp;·&nbsp; K-Anon Blur Active: <span id="kanonCount" style="color:var(--cyan)">0</span></div>
</div>

<!-- ══════════════════ MAIN ══════════════════ -->
<div id="main">

  <!-- SIDEBAR: Alert Feed -->
  <div id="sidebar">
    <div class="sb-header">
      <div class="sb-h-title">⚠ Risk Alert Feed</div>
      <div class="sb-h-badge" id="alertBadge">0 alerts</div>
    </div>
    <div id="alertFeed">
      <div class="alert-empty"><span>📡</span>Awaiting data stream...<br>Inject test reports to see alerts.</div>
    </div>
  </div>

  <!-- ANALYTICS VIEW -->
  <div id="analyticsView" style="flex:1;display:flex;flex-direction:column">
    <div id="content" class="analytics-view">

      <!-- KPI STRIP -->
      <div class="kpi-strip">
        <div class="kpi saffron">
          <div class="kpi-label">Total Reports (72h)</div>
          <div class="kpi-val saffron" id="kpi1">0</div>
          <div class="kpi-sub">Encrypted · Metadata visible</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi1bar" style="width:0%;background:var(--s)"></div></div>
        </div>
        <div class="kpi rose">
          <div class="kpi-label">Active Hotspots</div>
          <div class="kpi-val rose" id="kpi2">0</div>
          <div class="kpi-sub">≥3 same tag+dept / 72h</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi2bar" style="width:0%;background:var(--rose)"></div></div>
        </div>
        <div class="kpi green">
          <div class="kpi-label">Avg Sentiment</div>
          <div class="kpi-val green" id="kpi3">—</div>
          <div class="kpi-sub">User-reported intensity (1–10)</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi3bar" style="width:0%;background:var(--g)"></div></div>
        </div>
        <div class="kpi blue">
          <div class="kpi-label">Avg Urgency</div>
          <div class="kpi-val blue" id="kpi4">—</div>
          <div class="kpi-sub">Scale 1–5 across all reports</div>
          <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi4bar" style="width:0%;background:var(--blue)"></div></div>
        </div>
      </div>

      <!-- SENTIMENT TREND -->
      <div class="card" style="grid-column:span 2">
        <div class="card-head">
          <div class="card-title"><div class="dot g"></div>Sentiment Trend Over Time</div>
          <div class="card-meta" id="sentMeta">No data</div>
        </div>
        <div class="chart-wrap">
          <canvas id="sentimentChart" height="120"></canvas>
        </div>
      </div>

      <!-- CATEGORY DISTRIBUTION -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><div class="dot o"></div>Category Distribution</div>
          <div class="card-meta">By report volume</div>
        </div>
        <div class="cat-list" id="catList">
          <div style="text-align:center;color:var(--dim);font-size:11px;padding:20px;font-style:italic">No data yet</div>
        </div>
      </div>

      <!-- SCATTER PLOT: Urgency vs Time of Day -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><div class="dot b"></div>Urgency vs. Time of Day</div>
          <div class="card-meta">Correlation scatter</div>
        </div>
        <div class="corr-legend" id="scatterLegend"></div>
        <div class="chart-wrap" id="scatterWrap">
          <canvas id="scatterChart" height="180"></canvas>
        </div>
      </div>

      <!-- SIMULATION INPUT PANEL -->
      <div class="sim-submit-panel">
        <div class="ssp-title">Inject a Custom Report</div>
        <div class="ssp-sub">Choose metadata tags and submit to the analytics engine. The "complaint body" is simulated as encrypted blob — analytics see only the envelope below.</div>
        <div class="ssp-row">
          <div>
            <label class="mf-label">Category Tag</label>
            <select class="mf-select" id="inp-cat">
              <option value="Harassment">Harassment</option>
              <option value="Safety">Safety</option>
              <option value="Financial">Financial</option>
              <option value="Discrimination">Discrimination</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Whistleblower">Whistleblower</option>
            </select>
          </div>
          <div>
            <label class="mf-label">Department ID</label>
            <select class="mf-select" id="inp-dept">
              <option value="Engineering">Engineering</option>
              <option value="HR">Human Resources</option>
              <option value="Finance">Finance</option>
              <option value="Logistics">Logistics</option>
              <option value="Legal">Legal</option>
              <option value="Operations">Operations</option>
              <option value="Marketing">Marketing</option>
              <option value="Admin">Administration</option>
            </select>
          </div>
          <div>
            <label class="mf-label">Urgency Level</label>
            <div class="slider-row">
              <input type="range" min="1" max="5" value="3" class="mf-slider urgency" id="inp-urgency" oninput="document.getElementById('urgVal').textContent=this.value">
              <span class="slider-val" id="urgVal">3</span>
            </div>
          </div>
          <div>
            <label class="mf-label">Sentiment (1–10)</label>
            <div class="slider-row">
              <input type="range" min="1" max="10" value="6" class="mf-slider sentiment" id="inp-sentiment" oninput="document.getElementById('sentVal').textContent=this.value">
              <span class="slider-val" id="sentVal">6</span>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;justify-content:flex-end">
            <button class="btn btn-s" onclick="submitCustom()">Submit Report →</button>
          </div>
        </div>
      </div>

    </div><!-- /content analytics -->
  </div><!-- /analyticsView -->

  <!-- HEATMAP VIEW -->
  <div id="heatmapView" style="flex:1;display:none;flex-direction:column;padding:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <div style="font-family:var(--ff-head);font-size:20px;color:var(--ink)">Organisation <span style="color:var(--s);font-style:italic">Heatmap</span></div>
        <div style="font-size:11px;color:var(--dim);margin-top:3px">Department risk level — derived from encrypted report metadata only</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="privacy-toggle" onclick="toggleKAnon()" id="kanonToggle">
          <div class="pt-check" id="kanonCheck">✓</div>
          <span>K-Anonymity Blur (min 3 reports)</span>
        </div>
        <div class="blur-notice">🔒 BLIND ANALYTICS</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
      <span style="font-size:10px;color:var(--dim)">Risk Scale:</span>
      <div style="display:flex;gap:4px">
        <div style="width:36px;height:10px;background:#145A32;border-radius:2px"></div>
        <div style="width:36px;height:10px;background:#1E8449;border-radius:2px"></div>
        <div style="width:36px;height:10px;background:#F39C12;border-radius:2px"></div>
        <div style="width:36px;height:10px;background:#E67E22;border-radius:2px"></div>
        <div style="width:36px;height:10px;background:#E74C3C;border-radius:2px"></div>
      </div>
      <span style="font-size:9px;color:var(--dim)">None → Low → Moderate → High → Critical</span>
    </div>
    <div class="card" style="flex:1">
      <div class="card-head">
        <div class="card-title"><div class="dot r"></div>Department Risk Heatmap</div>
        <div class="card-meta" id="heatmapMeta">0 departments tracked</div>
      </div>
      <div id="deptGrid"></div>
    </div>
  </div><!-- /heatmapView -->

  <!-- ADMIN VIEW -->
  <div id="adminView" style="flex:1;padding:20px">
    <div class="admin-banner">
      <div class="admin-banner-icon">🛡</div>
      <div>
        <div class="admin-banner-t">Systems Administrator — Restricted Access</div>
        <div class="admin-banner-s">You have Volume Metrics and System Health access only. Complaint decryption is architecturally disabled. This view proves separation of <em>Data Analysis</em> from <em>Data Access</em>.</div>
      </div>
    </div>
    <div class="admin-sys-health" id="adminHealth">
      <div class="ash"><div class="ash-val" id="adm-total">0</div><div class="ash-lbl">Total Reports</div></div>
      <div class="ash"><div class="ash-val" style="color:var(--rose)" id="adm-hot">0</div><div class="ash-lbl">Active Hotspots</div></div>
      <div class="ash"><div class="ash-val" style="color:var(--g)">0</div><div class="ash-lbl">IPs Logged</div></div>
      <div class="ash"><div class="ash-val" style="color:var(--cyan)">0</div><div class="ash-lbl">Plaintext Exposed</div></div>
    </div>
    <div style="font-size:10px;font-weight:700;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px">Encrypted Records — Metadata Visible, Content Inaccessible</div>
    <div class="admin-grid" id="adminGrid">
      <div style="text-align:center;color:var(--dim);font-size:11px;padding:32px;font-style:italic;grid-column:span 3">No records. Inject test data to populate.</div>
    </div>
  </div><!-- /adminView -->

</div><!-- /main -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous"></script>
<script src="frontend/js/supabaseConfig.js"></script>
<script src="frontend/js/dataService.js"></script>
<script src="frontend/js/analytics.js"></script>
</body>
</html>